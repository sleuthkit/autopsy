language: java
sudo: required
dist: bionic
os:
 - linux

env:
 global:
  - TSK_HOME=$TRAVIS_BUILD_DIR/sleuthkit/sleuthkit

addons:
  apt:
    update: true
    packages:
    - libafflib-dev
    - libewf-dev
    - libpq-dev
    - autopoint
    - libsqlite3-dev
    - ant
    - ant-optional
    - libcppunit-dev
    - wget
    - openjdk-8-jdk
    - openjfx=8u161-b12-1ubuntu2
    - libopenjfx-java=8u161-b12-1ubuntu2
    - libopenjfx-jni=8u161-b12-1ubuntu2
  homebrew:
    update: true
    packages:
    - ant
    - ant-optional
    - libewf
    - gettext
    - cppunit
    - afflib

python:
  - "2.7"

before_install:
 - git clone https://github.com/sleuthkit/sleuthkit.git sleuthkit/sleuthkit
 - python setupSleuthkitBranch.py

install:
 - sudo apt-get install testdisk
 - cd sleuthkit/sleuthkit
 - ./travis_install_libs.sh

before_script:
  - if [ $TRAVIS_OS_NAME = linux ]; then 
        sudo update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java;
        sudo update-alternatives --set javac /usr/lib/jvm/java-8-openjdk-amd64/bin/javac;
        export PATH=/usr/bin:$PATH; 
        unset JAVA_HOME;
    fi
  - if [ $TRAVIS_OS_NAME = osx ]; then
        brew uninstall java --force;
        brew cask uninstall java --force;
        brew tap apoptopenjdk/openjdk;
        brew cask install adoptopenjdk8;
        wget https://cdn.azul.com/zulu/bin/zulu8.40.0.25-ca-fx-jdk8.0.222-macosx_x64.tar.gz | tar xf --strip-components=1 -C /Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home;
        export JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home;
    fi
  - java -version

script:
 - set -e
 - echo "Building TSK..."
 - ./bootstrap && ./configure --prefix=/usr && make
 - pushd bindings/java/ && ant -q dist-PostgreSQL && popd
 - echo "Building Autopsy..." && echo -en 'travis_fold:start:script.build\\r'
 - cd $TRAVIS_BUILD_DIR/
 - ant build
 - echo -en 'travis_fold:end:script.build\\r'
 - echo "Testing Autopsy..." && echo -en 'travis_fold:start:script.tests\\r'
 - cd Core/
 - ant -q getTestDataFiles
 - echo "Free Space:"
 - echo `df -h .` 
 - xvfb-run ant -q test
 - echo -en 'travis_fold:end:script.tests\\r'
